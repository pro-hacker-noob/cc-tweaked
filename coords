-- chat_coords_silent.lua
-- Silent listener: PMs coords on "getcoords" from pro_hacker_noob

local ALLOWED_USER = "pro_hacker_noob"

local chatBox = peripheral.find("chat_box") or peripheral.find("chatBox")
if not chatBox then return end

local function getCoords()
    if gps then
        local ok, x, y, z = pcall(gps.locate, 10)
        if ok and x then
            return math.floor(x+0.5), math.floor(y+0.5), math.floor(z+0.5)
        end
    end
    if commands and type(commands.getBlockPosition) == "function" then
        local ok, a, b, c = pcall(commands.getBlockPosition)
        if ok and a then
            return a, b, c
        end
    end
    return nil, nil, nil
end

local function pmPlayer(username, msg)
    pcall(function()
        if chatBox.sendMessageToPlayer then
            chatBox.sendMessageToPlayer(msg, username)
        else
            chatBox.sendMessage(msg, username)
        end
    end)
end

while true do
    local event, username, message, uuid, isHidden = os.pullEvent("chat")
    if username == ALLOWED_USER and message == "getcoords" then
        local x, y, z = getCoords()
        if x then
            pmPlayer(username, ("Coords for this computer: X=%d Y=%d Z=%d"):format(x, y, z))
        else
            pmPlayer(username, "Could not determine coordinates: no GPS and commands API unavailable.")
        end
        sleep(0.8)
    end
end
